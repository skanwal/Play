---
title: "Fusion Results"
author: "Sehrish Kanwal"
date: "01/10/2018"
output: html_document
---

```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = TRUE)
```

### Required packages

```{r}
suppressMessages(library(kableExtra))
```

### Pizzly filtering

```{r}
#read in the pizzly fusion calls
pizzly.fusions <- read.table(file = '~/Documents/UMCCR/data/fusions/pizzly-validation/MH17T001P013-oncofuse-test-flat-filtered.tsv', header = TRUE)

#read in the transcripts quantification file
quant <- read.table(file = '~/Documents/UMCCR/data/fusions/pizzly-validation/abundance.tsv', header = TRUE)

#sort and filter quantification file on tpm values. Currently filtering on quantiles. Selected 0.997 because that reduces the final fusion
#calls to the value we are interested in (~15)
quant.sorted.filtered <- filter(arrange(quant, desc(quant$tpm)), tpm >= (quantile(quant$tpm, 0.999)))

#initialize an empty dataframe
result <- data.frame()
result.list <- vector("list", length = nrow(pizzly.fusions))

#let's try using for loop for iterating over pizzly.fusions dataframe and get transcriptID and fusion gene pair information.
#can also filter quant.sorted.filtered$target_id to have only fusion gene target ids (that is two tracscripts instead of one-
#this will increase speed

for (row in 1:nrow(pizzly.fusions)){
  y <- strsplit(as.character(pizzly.fusions[row, 7]), "\\;")
  y <- unname(y)
  for (i in 1:length(y[[1]])){
    if (y[[1]][i] %in% quant.sorted.filtered$target_id){
      #val <- c(y[[1]][i], as.character(pizzly.fusions[row,1]), as.character(pizzly.fusions[row, 3]))
      #creating a new dataframe for the filtered pizzly results
      result <- rbind(result, data.frame(pizzly.fusions[row,]))
      #result.list[[row]] <- val
    }
  }
}

#remove duplicated values from result (as multiple transcripts might support fusion between same gene)
deduped.result.filtered <- unique(result)



kable(pizzly.fusions) %>%
  kable_styling(font_size = 10) %>%
  row_spec(as.numeric(rownames(deduped.result)), bold = T, color = "white", background = "#D7261E") %>%
  scroll_box(width = "100%", height = "200px")
```
